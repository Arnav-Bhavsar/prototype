<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Communication System</title>
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref, set, onValue, get } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

        const firebaseConfig = {
          apiKey: "AIzaSyBPeBffn5YYfydjZ8oKvpB5UHXS9r6d8sM",
          authDomain: "patient-monitor-ca78a.firebaseapp.com",
          databaseURL: "https://patient-monitor-ca78a-default-rtdb.firebaseio.com",
          projectId: "patient-monitor-ca78a",
          storageBucket: "patient-monitor-ca78a.firebasestorage.app",
          messagingSenderId: "454324690577",
          appId: "1:454324690577:web:7a068e27db8ddbb9f4a930"
        };

        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        const defaultQuickMessages = [
            "ðŸ’ŠðŸ’Š Time for medication ðŸ’ŠðŸ’Š",
            "ðŸ¥ªðŸ¥ª Time for lunch ðŸ¥ªðŸ¥ª"
        ];

        let audioContext;
        let lastMessageText = '';
        let messageTimeout;

        function playChime() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
            
            const now = audioContext.currentTime;
            
            const osc1 = audioContext.createOscillator();
            const gain1 = audioContext.createGain();
            osc1.connect(gain1);
            gain1.connect(audioContext.destination);
            osc1.frequency.setValueAtTime(600, now);
            gain1.gain.setValueAtTime(0.2, now);
            gain1.gain.exponentialRampToValueAtTime(0.01, now + 1.5);
            osc1.start(now);
            osc1.stop(now + 1.5);
            
            const osc2 = audioContext.createOscillator();
            const gain2 = audioContext.createGain();
            osc2.connect(gain2);
            gain2.connect(audioContext.destination);
            osc2.frequency.setValueAtTime(800, now + 0.3);
            gain2.gain.setValueAtTime(0.15, now + 0.3);
            gain2.gain.exponentialRampToValueAtTime(0.01, now + 1.8);
            osc2.start(now + 0.3);
            osc2.stop(now + 1.8);
        }
        
        function flashScreen() {
            const patientDiv = document.getElementById('patient');
            const originalBg = patientDiv.style.backgroundColor || 'white';
            
            let flashCount = 0;
            const flashInterval = setInterval(() => {
                if (flashCount % 2 === 0) {
                    patientDiv.style.backgroundColor = 'yellow';
                } else {
                    patientDiv.style.backgroundColor = originalBg;
                }
                flashCount++;
                
                if (flashCount >= 6) {
                    clearInterval(flashInterval);
                    patientDiv.style.backgroundColor = originalBg;
                }
            }, 300);
        }

        async function showCaretaker() {
            document.getElementById('caretaker').style.display = 'block';
            document.getElementById('patient').style.display = 'none';
            document.getElementById('modeSelection').style.display = 'none';
            await loadQuickMessages();
        }

        function showPatient() {
            document.getElementById('caretaker').style.display = 'none';
            document.getElementById('patient').style.display = 'block';
            document.getElementById('modeSelection').style.display = 'none';
            loadMessage();
        }

        async function loadQuickMessages() {
            const snapshot = await get(ref(database, 'quickMessages'));
            let messages = snapshot.val() || defaultQuickMessages;
            
            const container = document.getElementById('quickMessages');
            container.innerHTML = '';
            
            messages.forEach((msg, index) => {
                const button = document.createElement('button');
                button.textContent = msg;
                button.onclick = () => sendQuickMessage(msg);
                button.style.display = 'block';
                button.style.margin = '5px 0';
                button.style.padding = '10px';
                button.style.fontSize = '16px';
                container.appendChild(button);
            });
        }

        async function sendQuickMessage(message) {
            try {
                const timestamp = new Date().toLocaleString();
                await set(ref(database, 'currentMessage'), {
                    text: message,
                    timestamp: timestamp
                });
                
                document.getElementById('status').textContent = 'Message sent at ' + timestamp;
            } catch (error) {
                document.getElementById('status').textContent = 'Error sending message: ' + error.message;
                console.error(error);
            }
        }

        async function sendMessage() {
            const message = document.getElementById('messageInput').value;
            if (!message) return;

            try {
                const timestamp = new Date().toLocaleString();
                await set(ref(database, 'currentMessage'), {
                    text: message,
                    timestamp: timestamp
                });
                
                document.getElementById('messageInput').value = '';
                document.getElementById('status').textContent = 'Message sent at ' + timestamp;
            } catch (error) {
                document.getElementById('status').textContent = 'Error sending message: ' + error.message;
                console.error(error);
            }
        }

        async function saveQuickMessage() {
            const message = document.getElementById('newQuickMessage').value;
            if (!message) return;

            try {
                const snapshot = await get(ref(database, 'quickMessages'));
                let messages = snapshot.val() || defaultQuickMessages;
                messages.push(message);
                
                await set(ref(database, 'quickMessages'), messages);
                
                document.getElementById('newQuickMessage').value = '';
                document.getElementById('status').textContent = 'Quick message saved!';
                await loadQuickMessages();
            } catch (error) {
                document.getElementById('status').textContent = 'Error saving message: ' + error.message;
                console.error(error);
            }
        }

        function loadMessage() {
            const messageRef = ref(database, 'currentMessage');
            onValue(messageRef, (snapshot) => {
                const data = snapshot.val();
                
                if (data) {
                    if (data.text !== lastMessageText) {
                        playChime();
                        flashScreen();
                        lastMessageText = data.text;
                    }
                    
                    document.getElementById('messageDisplay').textContent = data.text;
                    
                    if (messageTimeout) {
                        clearTimeout(messageTimeout);
                    }
                    
                    messageTimeout = setTimeout(() => {
                        document.getElementById('messageDisplay').textContent = 'Waiting for message...';
                        lastMessageText = '';
                    }, 5 * 60 * 1000);
                } else {
                    document.getElementById('messageDisplay').textContent = 'Waiting for message...';
                }
            });
        }

        function goBack() {
            location.reload();
        }

        window.addEventListener('DOMContentLoaded', () => {
            document.getElementById('caretakerBtn').addEventListener('click', showCaretaker);
            document.getElementById('patientBtn').addEventListener('click', showPatient);
            document.getElementById('sendBtn').addEventListener('click', sendMessage);
            document.getElementById('saveBtn').addEventListener('click', saveQuickMessage);
            document.getElementById('backBtn').addEventListener('click', goBack);
        });
    </script>
</head>
<body>
    <div id="modeSelection">
        <h1>Select Mode</h1>
        <button id="caretakerBtn">Caretaker (Send Message)</button>
        <button id="patientBtn">Patient Monitor (Receive Message)</button>
    </div>

    <div id="caretaker" style="display:none;">
        <h2>Caretaker - Send Message</h2>
        
        <h3>Quick Messages</h3>
        <div id="quickMessages"></div>
        
        <h3>Custom Message</h3>
        <input type="text" id="messageInput" placeholder="Enter custom message">
        <button id="sendBtn">Send Custom</button>
        
        <h3>Save New Quick Message</h3>
        <input type="text" id="newQuickMessage" placeholder="Enter message to save">
        <button id="saveBtn">Save</button>
        
        <p id="status"></p>
    </div>

    <div id="patient" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; margin:0; padding:20px; box-sizing:border-box; background-color:white;">
        <button id="backBtn" style="position:absolute; top:10px; left:10px; font-size:16px;">Back</button>
        <div id="messageDisplay" style="font-size:10vw; display:flex; align-items:center; justify-content:center; height:100%; width:100%; text-align:center;">Waiting for message...</div>
    </div>
</body>
</html>